# Workflow derived from https://github.com/r-lib/actions/tree/v2/examples
#
# Slash commands for PR maintainers:
#   /document  -- re-run devtools::document() and push updated man/ + NAMESPACE
#   /style     -- format with air and push the result
on:
    issue_comment:
        types: [created]

name: pr-commands.yaml

permissions: {}

jobs:
    document:
        if: >
            github.event.issue.pull_request &&
            (github.event.comment.author_association == 'MEMBER' ||
             github.event.comment.author_association == 'OWNER') &&
            startsWith(github.event.comment.body, '/document')
        name: document
        runs-on: ubuntu-latest
        env:
            GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4

            - uses: r-lib/actions/pr-fetch@v2
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

            - uses: r-lib/actions/setup-r@v2
              with:
                  use-public-rspm: true

            - uses: r-lib/actions/setup-r-dependencies@v2
              with:
                  extra-packages: any::devtools
                  needs: pr-document

            - name: Document
              shell: Rscript {0}
              run: devtools::document()

            - name: Commit
              run: |
                  git config --local user.name "$GITHUB_ACTOR"
                  git config --local user.email "$GITHUB_ACTOR@users.noreply.github.com"
                  git add man/* NAMESPACE
                  git commit -m 'Document' || echo "No changes to commit"

            - uses: r-lib/actions/pr-push@v2
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

    style:
        if: >
            github.event.issue.pull_request &&
            (github.event.comment.author_association == 'MEMBER' ||
             github.event.comment.author_association == 'OWNER') &&
            startsWith(github.event.comment.body, '/style')
        name: style
        runs-on: ubuntu-latest
        env:
            GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4

            - uses: r-lib/actions/pr-fetch@v2
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Install air
              uses: posit-dev/setup-air@v1

            - name: Format
              run: air format .

            - name: Commit changes
              run: |
                  git config --local user.name "$GITHUB_ACTOR"
                  git config --local user.email "$GITHUB_ACTOR@users.noreply.github.com"
                  git commit -am 'Format with air' || echo "No changes to commit"
              continue-on-error: true

            - uses: r-lib/actions/pr-push@v2
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
